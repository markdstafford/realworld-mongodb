# Migration Changelog

This document tracks all significant codebase modifications made during the H2 to MongoDB migration. Each entry includes the date, the task it relates to, the reason for the change, a diff of the modifications, and the success criteria met.

---

## 2025-06-11 - Fix `schema.sql` for H2 Compatibility

**Related Task:** Phase 0, Task 0.2 (Execute initial tests and establish baseline - Prerequisite Fix)

**Reason for Change:**

During the initial execution of `./gradlew clean test` as part of establishing the project baseline, a test failure occurred:
`RealWorldApplicationTest > contextLoads() FAILED`
  `java.lang.IllegalStateException at DefaultCacheAwareContextLoaderDelegate.java:180`
    `Caused by: org.springframework.beans.factory.BeanCreationException at AbstractBeanFactory.java:326`
      `Caused by: org.springframework.beans.factory.BeanCreationException at AbstractAutowireCapableBeanFactory.java:1788`
        `Caused by: org.springframework.jdbc.datasource.init.ScriptStatementFailedException at ScriptUtils.java:282`
          `Caused by: org.h2.jdbc.JdbcSQLSyntaxErrorException at DbException.java:514`
          `Syntax error in SQL statement "create [*]database realworld"; SQL statement: create database realworld [42001-224]`

The root cause was the `CREATE DATABASE realworld;` statement in `module/persistence/src/main/resources/schema.sql`. This command is not valid for H2 when used in this manner, as H2 typically handles database creation implicitly based on the JDBC URL (for in-memory or file-based databases). Spring Boot's schema initialization was attempting to run this script, leading to the H2 syntax error.

The fix involved removing this incompatible line from `schema.sql`.

**Code Diff (`module/persistence/src/main/resources/schema.sql`):**

```diff
--- a/module/persistence/src/main/resources/schema.sql
+++ b/module/persistence/src/main/resources/schema.sql
@@ -1,5 +1,3 @@
-create database realworld;
-
 create table article
 (
     id          integer generated by default as identity,

```

**Success Criteria:**

- After applying the fix, the `./gradlew clean test` command completed successfully.
- All 15 unit tests passed.
- A stable project baseline with a correctly functioning H2 database setup was established, allowing the migration to proceed.
---

## 2025-06-11 - Task 0.3: Update project dependencies (Conservative)

**Related Task:** Phase 0, Task 0.3 (Update project dependencies)

**Reason for Change:**

As per the migration plan and user instruction, project dependencies were updated to their latest stable *patch* versions. This conservative approach aims to incorporate bug fixes and minor improvements without risking breaking changes that major or minor version bumps might introduce. The `dependencyUpdates` Gradle task was not available (missing `com.github.ben-manes.versions` plugin), so versions were checked and updated manually in `gradle/libs.versions.toml`.

Updated dependencies include:
- Spring Boot (core framework)
- Spring Dependency Management (Gradle plugin)
- P6Spy Spring Boot Starter (SQL logging)

The Spotless Gradle plugin version (`spotless`) was initially attempted to be updated from `7.0.3` to `7.0.5`. However, `7.0.5` was not found in plugin repositories. Version `7.0.3` was confirmed to be the latest available patch in its series at the time of update and thus remained unchanged.

**Code Diff (`gradle/libs.versions.toml`):**

```diff
--- a/gradle/libs.versions.toml
+++ b/gradle/libs.versions.toml
@@ -1,10 +1,10 @@
 [versions]
 java = "21"
 spotless = "7.0.3"
 
-spring-boot = "3.3.0"
-spring-dependency-management = "1.1.5"
-spring-boot-p6spy = "1.9.0"
+spring-boot = "3.3.6"
+spring-dependency-management = "1.1.6"
+spring-boot-p6spy = "1.9.1"
 
 [libraries]
 lombok = { group = "org.projectlombok", name = "lombok" }

```

**Success Criteria:**

- The `gradle/libs.versions.toml` file is updated with the new patch versions for the specified dependencies (Spring Boot, Spring Dependency Management, P6Spy). Spotless version remains `7.0.3`.
- The next step (Task 0.4) will be to validate these changes by running the full test suite.
---

## 2025-06-11 - Task 0.4: Validate dependency updates

**Related Task:** Phase 0, Task 0.4 (Validate dependency updates)

**Reason for Change:**

To ensure that the conservative dependency updates made in Task 0.3 did not introduce any regressions or compatibility issues into the project.

**Process:**

1.  The `gradle/libs.versions.toml` file was updated with conservative patch versions for Spring Boot (to `3.3.6`), Spring Dependency Management (to `1.1.6`), and P6Spy Spring Boot Starter (to `1.9.1`). The Spotless version remained at `7.0.3` as it was already the latest in its patch series.
2.  The full unit test suite was executed using the command: `./gradlew clean test`.

**Success Criteria:**

- The project compiled successfully with the updated dependencies.
- All 15 unit tests passed after the dependency updates.
- **Phase 0: Project baseline and health check is now complete.** The project has a stable baseline, a documented and validated testing protocol, and updated dependencies (conservatively), with all tests passing.
---

## 2025-06-11 - Task 1.1: Integrate MongoDB dependency

**Related Task:** Phase 1, Task 1.1 (Integrate MongoDB dependency)

**Reason for Change:**

To add the `spring-boot-starter-data-mongodb` dependency to the `module/persistence` module. This is the first step in Phase 1, preparing the project for MongoDB integration by making the necessary Spring Data MongoDB libraries available.

**Code Diff (`module/persistence/build.gradle.kts`):**

```diff
--- a/module/persistence/build.gradle.kts
+++ b/module/persistence/build.gradle.kts
@@ -6,6 +6,7 @@
     implementation(libs.spring.boot.starter.data.jpa)
     implementation(libs.spring.boot.starter.cache)
     implementation(libs.spring.boot.starter.p6spy)
+    implementation("org.springframework.boot:spring-boot-starter-data-mongodb")
 
     implementation(libs.cache.caffeine)
 }

```

**Success Criteria:**

- The `org.springframework.boot:spring-boot-starter-data-mongodb` dependency is added to the `dependencies` block in `module/persistence/build.gradle.kts`.
- The changelog is updated with this entry.
- The full test suite (unit tests via `./gradlew clean test`) will be run against the default H2 configuration to ensure this addition does not introduce any immediate regressions. All tests must pass.
---

## 2025-06-11 - Task 1.2: Isolate database configurations using profiles

**Related Task:** Phase 1, Task 1.2 (Isolate database configurations using profiles)

**Reason for Change:**

To separate H2 and MongoDB specific configurations into distinct Spring profiles. This allows the application to switch between database types by activating the appropriate profile, a key requirement for the phased migration strategy. This change ensures that H2 remains the default configuration while preparing for MongoDB integration.

**Summary of Files Created/Modified:**

*   **Created:** `module/persistence/src/main/resources/application-h2.yaml`
    *   Moved all H2-specific properties (datasource URL, JPA DDL auto, P6Spy settings) from the main `application.yaml` in the persistence module into this file.
    *   Content:
        ```yaml
        spring:
          datasource:
            url: jdbc:h2:mem:testdb?MODE=MYSQL;
        
          jpa:
            open-in-view: false
            hibernate:
              ddl-auto: create-drop
        
        decorator:
          datasource:
            p6spy:
              enable-logging: true
        ```

*   **Created:** `module/persistence/src/main/resources/application-mongodb.yaml`
    *   Added initial placeholder configuration for MongoDB, including `spring.data.mongodb.uri`.
    *   Content:
        ```yaml
        spring:
          data:
            mongodb:
              uri: mongodb://localhost:27017/realworld_placeholder
        ```

*   **Modified:** `module/persistence/src/main/resources/application.yaml`
    *   Removed H2-specific properties. The file now contains comments indicating that database configurations are profile-specific.
    *   Diff:
        ```diff
        --- a/module/persistence/src/main/resources/application.yaml
        +++ b/module/persistence/src/main/resources/application.yaml
        @@ -1,13 +1,7 @@
        -spring:
        -  datasource:
        -    url: jdbc:h2:mem:testdb?MODE=MYSQL;
        -
        -  jpa:
        -    open-in-view: false
        -    hibernate:
        -      ddl-auto: create-drop
        -
        -decorator:
        -  datasource:
        -    p6spy:
        -      enable-logging: true
        +# This file is intentionally left almost empty.
        +# All database-specific configurations have been moved to profile-specific files:
        +# - application-h2.yaml (for H2 database, default)
        +# - application-mongodb.yaml (for MongoDB)
        +#
        +# Spring Boot will load the appropriate file based on the active profile.
        +# The active profile is set in server/api/src/main/resources/application.yaml
        ```

*   **Modified:** `server/api/src/main/resources/application.yaml`
    *   Added `spring.profiles.active=h2` to explicitly set H2 as the default active profile for the application.
    *   Diff:
        ```diff
        --- a/server/api/src/main/resources/application.yaml
        +++ b/server/api/src/main/resources/application.yaml
        @@ -11,3 +11,5 @@
           threads:
             virtual:
               enabled: true
        +  profiles:
        +    active: h2
        ```

**Success Criteria:**

- Configuration properties are correctly split into `application-h2.yaml` and `application-mongodb.yaml` within the `module/persistence/src/main/resources/` directory.
- The `module/persistence/src/main/resources/application.yaml` file is updated to reflect that configurations are now profile-based.
- The `server/api/src/main/resources/application.yaml` file sets `spring.profiles.active=h2`, ensuring H2 is the default.
- The changelog is updated with this entry.
- The full test suite (unit tests via `./gradlew clean test`) passes, confirming that the application still runs correctly with the H2 profile active by default (to be validated in the next step).
---

## 2025-06-11 - Task 1.3: Make configuration beans profile-specific

**Related Task:** Phase 1, Task 1.3 (Make configuration beans profile-specific)

**Reason for Change:**

To ensure that JPA-specific configuration beans (`JpaConfiguration` and `DataSourceConfiguration`) are only loaded when the "h2" Spring profile is active. This prevents these H2/JPA related beans from being instantiated and potentially causing conflicts when the application is later run with the "mongodb" profile. This step further isolates the H2 and MongoDB configurations.

**Code Diffs:**

*   **`module/persistence/src/main/java/io/zhc1/realworld/config/JpaConfiguration.java`**:
    ```diff
    --- a/module/persistence/src/main/java/io/zhc1/realworld/config/JpaConfiguration.java
    +++ b/module/persistence/src/main/java/io/zhc1/realworld/config/JpaConfiguration.java
    @@ -1,8 +1,10 @@
     package io.zhc1.realworld.config;
     
     import org.springframework.context.annotation.Configuration;
    +import org.springframework.context.annotation.Profile;
     import org.springframework.data.jpa.repository.config.EnableJpaAuditing;
     
    +@Profile("h2")
     @Configuration
     @EnableJpaAuditing
     class JpaConfiguration {}
    ```

*   **`module/persistence/src/main/java/io/zhc1/realworld/config/DataSourceConfiguration.java`**:
    ```diff
    --- a/module/persistence/src/main/java/io/zhc1/realworld/config/DataSourceConfiguration.java
    +++ b/module/persistence/src/main/java/io/zhc1/realworld/config/DataSourceConfiguration.java
    @@ -9,10 +9,12 @@
     import org.hibernate.engine.jdbc.internal.FormatStyle;
     import org.hibernate.engine.jdbc.internal.Formatter;
     import org.springframework.context.annotation.Configuration;
    +import org.springframework.context.annotation.Profile;
     
     import com.p6spy.engine.spy.P6SpyOptions;
     import com.p6spy.engine.spy.appender.MessageFormattingStrategy;
     
    +@Profile("h2")
     @Configuration
     class DataSourceConfiguration {
         @PostConstruct
    ```

**Success Criteria:**

- The `@Profile("h2")` annotation is added to the `JpaConfiguration` class in `io.zhc1.realworld.config` package.
- The `@Profile("h2")` annotation is added to the `DataSourceConfiguration` class in the `io.zhc1.realworld.config` package.
- The changelog is updated with this entry.
- The full test suite (unit tests via `./gradlew clean test`) passes, confirming that the application still loads these beans correctly when the default H2 profile is active (to be validated in the next step by the assistant).
---

## 2025-06-11 - Task 1.4: Configure MongoDB transaction management

**Related Task:** Phase 1, Task 1.4 (Configure MongoDB transaction management)

**Reason for Change:**

To introduce a `MongoTransactionManager` bean that will be active only when the "mongodb" Spring profile is enabled. This is essential for supporting transactions with MongoDB, allowing operations across multiple documents or collections to be treated as a single atomic unit if required by the application logic during and after the migration. This completes the foundational setup for MongoDB in the persistence layer.

**Code (New file: `module/persistence/src/main/java/io/zhc1/realworld/config/MongoConfiguration.java`):**

```java
package io.zhc1.realworld.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import org.springframework.data.mongodb.MongoDatabaseFactory;
import org.springframework.data.mongodb.MongoTransactionManager;

@Profile("mongodb")
@Configuration
class MongoConfiguration {

    @Bean
    MongoTransactionManager transactionManager(MongoDatabaseFactory dbFactory) {
        return new MongoTransactionManager(dbFactory);
    }
}
```

**Success Criteria:**

- A new class `MongoConfiguration.java` is created in the `io.zhc1.realworld.config` package within the `module/persistence` module.
- This class is annotated with `@Configuration` and `@Profile("mongodb")`.
- It defines a bean of type `MongoTransactionManager` named `transactionManager`, which takes a `MongoDatabaseFactory` as a parameter.
- The changelog is updated with this entry.
- The full test suite (unit tests via `./gradlew clean test`) passes with the default H2 profile active, ensuring this addition (inactive by default) does not affect the current H2 setup.
- **Phase 1: Setup and dependency management is now complete.** The project is now equipped with the necessary MongoDB dependencies and profile-based configurations for both H2 and MongoDB, with H2 remaining the default and fully functional.
---

## 2025-06-11 - Task 2.1: Refactor User persistence

**Related Task:** Phase 2, Task 2.1 (Refactor User persistence)

**Reason for Change:**

To migrate the `User` entity and its associated persistence layer components (repository interface, repository adapter) from JPA/H2 to Spring Data MongoDB. This is the first entity to be migrated. Initial refactoring led to build and test failures due to missing dependencies in the `core` module and conflicting Spring Data repository bean definitions. These issues were subsequently resolved by adding necessary dependencies, refining repository configuration scanning, and excluding default Spring Data auto-configurations.

**Summary of Changes:**

*   **Annotate `User` entity for MongoDB:**
    *   File: `module/core/src/main/java/io/zhc1/realworld/model/User.java`
    *   Change: Added `@org.springframework.data.mongodb.core.mapping.Document(collection = "users")` annotation to the `User` class. The existing JPA `@Entity` and `@Table` annotations are retained for H2 compatibility.
    *   Diff:
        ```diff
        --- a/module/core/src/main/java/io/zhc1/realworld/model/User.java
        +++ b/module/core/src/main/java/io/zhc1/realworld/model/User.java
        @@ -16,8 +16,11 @@
         import lombok.NoArgsConstructor;
         import lombok.extern.slf4j.Slf4j;
         
        +import org.springframework.data.mongodb.core.mapping.Document;
        +
         @Slf4j
         @Entity
        +@Document(collection = "users") // Added for MongoDB
         @Getter
         @Table(name = "users")
         @NoArgsConstructor(access = AccessLevel.PROTECTED)
        ```

*   **Create `UserMongoRepository` interface:**
    *   New File: `module/persistence/src/main/java/io/zhc1/realworld/persistence/UserMongoRepository.java`
    *   Content: Interface extending `org.springframework.data.mongodb.repository.MongoRepository<User, UUID>` with method signatures equivalent to those in `UserJpaRepository` (e.g., `findByEmail`, `findByUsername`, `existsByEmail`, `existsByUsername`, `existsByEmailOrUsername`).
    *   Code:
        ```java
        package io.zhc1.realworld.persistence;
        
        import java.util.Optional;
        import java.util.UUID;
        
        import org.springframework.data.mongodb.repository.MongoRepository;
        
        import io.zhc1.realworld.model.User;
        
        interface UserMongoRepository extends MongoRepository<User, UUID> {
            Optional<User> findByEmail(String email);
            Optional<User> findByUsername(String username);
            boolean existsByEmail(String email);
            boolean existsByUsername(String username);
            boolean existsByEmailOrUsername(String email, String username);
        }
        ```

*   **Isolate existing JPA Adapter (`UserRepositoryAdapter`):**
    *   File Renamed: `module/persistence/src/main/java/io/zhc1/realworld/persistence/UserRepositoryAdapter.java` to `UserJpaRepositoryAdapter.java`.
    *   Class Name Change: The class name within the file was updated from `UserRepositoryAdapter` to `UserJpaRepositoryAdapter`.
    *   Annotation Added: `@org.springframework.context.annotation.Profile("h2")` was added to the `UserJpaRepositoryAdapter` class to ensure it's only active for the H2 profile.
    *   Diff (Illustrative - actual change includes class rename):
        ```diff
        --- a/module/persistence/src/main/java/io/zhc1/realworld/persistence/UserJpaRepositoryAdapter.java
        +++ b/module/persistence/src/main/java/io/zhc1/realworld/persistence/UserJpaRepositoryAdapter.java
        @@ -3,6 +3,7 @@
         import java.util.Optional;
         import java.util.UUID;
         
        +import org.springframework.context.annotation.Profile;
         import org.springframework.stereotype.Repository;
         import org.springframework.transaction.annotation.Transactional;
         
        @@ -12,6 +13,7 @@
         import io.zhc1.realworld.model.User;
         import io.zhc1.realworld.model.UserRepository;
         
        +@Profile("h2")
         @Repository
         @RequiredArgsConstructor
         class UserJpaRepositoryAdapter implements UserRepository { // Class name also changed
        ```

*   **Create `UserMongoRepositoryAdapter` for MongoDB:**
    *   New File: `module/persistence/src/main/java/io/zhc1/realworld/persistence/UserMongoRepositoryAdapter.java`
    *   Content: A new class implementing the `io.zhc1.realworld.model.UserRepository` interface.
        *   Annotated with `@org.springframework.stereotype.Component("userMongoRepositoryAdapter")` (explicit bean name) and `@org.springframework.context.annotation.Profile("mongodb")`.
        *   Injects and uses the `UserMongoRepository` for its data access operations.
        *   Methods mirror those in `UserJpaRepositoryAdapter` but interact with MongoDB.
    *   Code:
        ```java
        package io.zhc1.realworld.persistence;
        // ... imports ...
        @Profile("mongodb")
        @Component("userMongoRepositoryAdapter")
        @RequiredArgsConstructor
        class UserMongoRepositoryAdapter implements UserRepository {
            private final UserMongoRepository userMongoRepository;
            // ... method implementations ...
        }
        ```

*   **Add Unit Tests for `UserMongoRepositoryAdapter`:**
    *   New File: `module/persistence/src/test/java/io/zhc1/realworld/persistence/UserMongoRepositoryAdapterTest.java`
    *   Content: Comprehensive JUnit 5 tests using Mockito to mock `UserMongoRepository` and `PasswordEncoder`.

*   **Addressing Build & Test Failures:**
    *   **Added MongoDB dependency to `module/core`:**
        *   File: `module/core/build.gradle.kts`
        *   Change: Added `implementation("org.springframework.boot:spring-boot-starter-data-mongodb")` to allow usage of `@Document` annotation in core entities.
        *   Diff:
            ```diff
            --- a/module/core/build.gradle.kts
            +++ b/module/core/build.gradle.kts
            @@ -4,5 +4,6 @@
             
             dependencies {
                 implementation(libs.jakarta.persistence.api)
            +    implementation("org.springframework.boot:spring-boot-starter-data-mongodb") // Added for MongoDB annotations like @Document
                 testFixturesImplementation(libs.jakarta.persistence.api)
             }
            ```

    *   **Fixed Test Stubbing in `UserMongoRepositoryAdapterTest`:**
        *   File: `module/persistence/src/test/java/io/zhc1/realworld/persistence/UserMongoRepositoryAdapterTest.java`
        *   Change: Refined Mockito stubbing, particularly for `userMongoRepository.save()` and conditional `findById()` calls, to avoid `UnnecessaryStubbingException` and ensure tests accurately reflect method logic. Moved general `save()` stubbing into individual tests where it's used.
        *   Illustrative Diff Snippet:
            ```diff
            --- a/module/persistence/src/test/java/io/zhc1/realworld/persistence/UserMongoRepositoryAdapterTest.java
            +++ b/module/persistence/src/test/java/io/zhc1/realworld/persistence/UserMongoRepositoryAdapterTest.java
            @@ -232,15 +232,14 @@
             
                     @BeforeEach
                     void updateSetup() {
            -            // Ensure findById returns the sampleUser for update operations
            +            // Default stub for findById, can be overridden by specific tests.
                         when(userMongoRepository.findById(userId)).thenReturn(Optional.of(sampleUser));
            -            // Default save behavior
            -            when(userMongoRepository.save(any(User.class))).thenAnswer(invocation -> invocation.getArgument(0));
                     }
             
                     @Test
                     @DisplayName("when user exists and all data is valid, should update and return user")
                     void updateUserDetails_whenUserExistsAndDataIsValid_shouldUpdateAndReturnUser() {
            +            when(userMongoRepository.save(any(User.class))).thenAnswer(invocation -> invocation.getArgument(0));
                         when(passwordEncoder.encode(newPassword)).thenReturn("encodedNewPassword");
                         // Make passwordEncoder.matches return false so password gets updated
                         when(passwordEncoder.matches(newPassword, sampleUser.getPassword())).thenReturn(false);
            ```

    *   **Refined Repository Scanning in Configurations:**
        *   File: `module/persistence/src/main/java/io/zhc1/realworld/config/JpaConfiguration.java`
        *   Change: Added `@EnableJpaRepositories` with `includeFilters` to scan only interfaces ending with `JpaRepository`.
        *   Diff:
            ```diff
            --- a/module/persistence/src/main/java/io/zhc1/realworld/config/JpaConfiguration.java
            +++ b/module/persistence/src/main/java/io/zhc1/realworld/config/JpaConfiguration.java
            @@ -1,10 +1,17 @@
             package io.zhc1.realworld.config;
             
            +import org.springframework.context.annotation.ComponentScan.Filter;
             import org.springframework.context.annotation.Configuration;
            +import org.springframework.context.annotation.FilterType;
             import org.springframework.context.annotation.Profile;
             import org.springframework.data.jpa.repository.config.EnableJpaAuditing;
            +import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
             
             @Profile("h2")
             @Configuration
             @EnableJpaAuditing
            +@EnableJpaRepositories(
            +    basePackages = "io.zhc1.realworld.persistence",
            +    includeFilters = @Filter(type = FilterType.REGEX, pattern = ".*JpaRepository")
            +)
             class JpaConfiguration {}
            ```
        *   File: `module/persistence/src/main/java/io/zhc1/realworld/config/MongoConfiguration.java`
        *   Change: Added `@EnableMongoRepositories` with `includeFilters` to scan only interfaces ending with `MongoRepository`.
        *   Diff:
            ```diff
            --- a/module/persistence/src/main/java/io/zhc1/realworld/config/MongoConfiguration.java
            +++ b/module/persistence/src/main/java/io/zhc1/realworld/config/MongoConfiguration.java
            @@ -1,13 +1,20 @@
             package io.zhc1.realworld.config;
             
             import org.springframework.context.annotation.Bean;
            +import org.springframework.context.annotation.ComponentScan.Filter;
             import org.springframework.context.annotation.Configuration;
            +import org.springframework.context.annotation.FilterType;
             import org.springframework.context.annotation.Profile;
             import org.springframework.data.mongodb.MongoDatabaseFactory;
             import org.springframework.data.mongodb.MongoTransactionManager;
            +import org.springframework.data.mongodb.repository.config.EnableMongoRepositories;
             
             @Profile("mongodb")
             @Configuration
            +@EnableMongoRepositories(
            +    basePackages = "io.zhc1.realworld.persistence",
            +    includeFilters = @Filter(type = FilterType.REGEX, pattern = ".*MongoRepository")
            +)
             class MongoConfiguration {
             
                 @Bean
            ```

    *   **Excluded Auto-configuration for Repositories:**
        *   File: `server/api/src/main/java/io/zhc1/realworld/RealWorldApplication.java`
        *   Change: Added `exclude = {JpaRepositoriesAutoConfiguration.class, MongoRepositoriesAutoConfiguration.class}` to `@SpringBootApplication` to prevent default repository scanning and rely on explicit configurations.
        *   Diff:
            ```diff
            --- a/server/api/src/main/java/io/zhc1/realworld/RealWorldApplication.java
            +++ b/server/api/src/main/java/io/zhc1/realworld/RealWorldApplication.java
            @@ -2,8 +2,13 @@
             
             import org.springframework.boot.SpringApplication;
             import org.springframework.boot.autoconfigure.SpringBootApplication;
            +import org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration;
            +import org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration;
             
            -@SpringBootApplication
            +@SpringBootApplication(exclude = {
            +    JpaRepositoriesAutoConfiguration.class,
            +    MongoRepositoriesAutoConfiguration.class
            +})
             public class RealWorldApplication {
                 public static void main(String[] args) {
                     SpringApplication.run(RealWorldApplication.class, args);
            ```

**Success Criteria:**

- The `User.java` entity in `module/core` is correctly annotated with `@Document(collection = "users")` alongside existing JPA annotations, and `module/core` has the necessary MongoDB dependency.
- The `UserMongoRepository.java` interface is created in `module/persistence`, extends `MongoRepository<User, UUID>`, and contains all required data access method signatures.
- The `UserJpaRepositoryAdapter.java` in `module/persistence` is correctly renamed, annotated with `@Profile("h2")`, and implements `UserRepository` using `UserJpaRepository`.
- The new `UserMongoRepositoryAdapter.java` is created in `module/persistence`, implements `UserRepository`, is annotated with `@Component("userMongoRepositoryAdapter")` and `@Profile("mongodb")`, and correctly uses `UserMongoRepository`.
- The new `UserMongoRepositoryAdapterTest.java` is created and its tests pass after stubbing corrections.
- `JpaConfiguration` and `MongoConfiguration` are updated with profile-specific `@EnableJpaRepositories` and `@EnableMongoRepositories` respectively, using filters to prevent bean conflicts.
- `RealWorldApplication` excludes default JPA and MongoDB repository auto-configurations.
- The changelog is updated with this entry, including details of the fixes.
- The full application test suite (`./gradlew clean test`) passes with the default "h2" profile active, confirming no regressions and that the application context loads correctly.
---

## 2025-06-11 - Task 2.2: Refactor Tag persistence

**Related Task:** Phase 2, Task 2.2 (Refactor Tag persistence)

**Reason for Change:**

To migrate the `Tag` entity and its associated persistence layer components (repository interface, repository adapter) from JPA/H2 to Spring Data MongoDB. This follows the established pattern from the `User` entity migration (Task 2.1). The `Tag` entity is simpler than `User`, primarily involving a `findAll` operation and using a `String` as its ID, which streamlined this part of the migration. No new unit tests were required for this specific adapter as per the migration task list, unlike the `User` adapter.

**Summary of Changes:**

*   **Annotate `Tag` entity for MongoDB:**
    *   File: `module/core/src/main/java/io/zhc1/realworld/model/Tag.java`
    *   Change: Added `@org.springframework.data.mongodb.core.mapping.Document(collection = "tags")` annotation to the `Tag` class. Existing JPA annotations (`@Entity`, `@Table`, `@Id`) are retained for H2 compatibility.
    *   Diff:
        ```diff
        --- a/module/core/src/main/java/io/zhc1/realworld/model/Tag.java
        +++ b/module/core/src/main/java/io/zhc1/realworld/model/Tag.java
        @@ -12,7 +12,10 @@
         import lombok.Getter;
         import lombok.NoArgsConstructor;
         
        +import org.springframework.data.mongodb.core.mapping.Document;
        +
         @Entity
        +@Document(collection = "tags") // Added for MongoDB
         @Getter
         @Table(name = "tag")
         @SuppressWarnings("JpaDataSourceORMInspection")
        ```

*   **Create `TagMongoRepository` interface:**
    *   New File: `module/persistence/src/main/java/io/zhc1/realworld/persistence/TagMongoRepository.java`
    *   Content: Interface extending `org.springframework.data.mongodb.repository.MongoRepository<Tag, String>`. No custom methods were needed, similar to `TagJpaRepository`.
    *   Code:
        ```java
        package io.zhc1.realworld.persistence;
        
        import org.springframework.data.mongodb.repository.MongoRepository;
        
        import io.zhc1.realworld.model.Tag;
        
        interface TagMongoRepository extends MongoRepository<Tag, String> {
            // No custom methods needed, similar to TagJpaRepository
        }
        ```

*   **Isolate existing JPA Adapter (`TagRepositoryAdapter`):**
    *   File Renamed: `module/persistence/src/main/java/io/zhc1/realworld/persistence/TagRepositoryAdapter.java` to `TagJpaRepositoryAdapter.java`.
    *   Class Name Change: The class name within the file was updated from `TagRepositoryAdapter` to `TagJpaRepositoryAdapter`.
    *   Annotation Added: `@org.springframework.context.annotation.Profile("h2")` was added to the `TagJpaRepositoryAdapter` class.
    *   Diff (Illustrative - actual change includes class rename and import):
        ```diff
        --- a/module/persistence/src/main/java/io/zhc1/realworld/persistence/TagJpaRepositoryAdapter.java
        +++ b/module/persistence/src/main/java/io/zhc1/realworld/persistence/TagJpaRepositoryAdapter.java
        @@ -3,6 +3,7 @@
         import java.util.List;
         
         import org.springframework.cache.annotation.Cacheable;
        +import org.springframework.context.annotation.Profile; // Added import
         import org.springframework.stereotype.Repository;
         
         import lombok.RequiredArgsConstructor;
        @@ -12,9 +13,10 @@
         import io.zhc1.realworld.model.Tag;
         import io.zhc1.realworld.model.TagRepository;
         
        +@Profile("h2") // Added annotation
         @Repository
         @RequiredArgsConstructor
        -class TagRepositoryAdapter implements TagRepository {
        +class TagJpaRepositoryAdapter implements TagRepository { // Changed class name
             private final TagJpaRepository tagJpaRepository;
         
             @Override
        ```

*   **Create `TagMongoRepositoryAdapter` for MongoDB:**
    *   New File: `module/persistence/src/main/java/io/zhc1/realworld/persistence/TagMongoRepositoryAdapter.java`
    *   Content: A new class implementing `io.zhc1.realworld.model.TagRepository`.
        *   Annotated with `@org.springframework.stereotype.Component("tagMongoRepositoryAdapter")` (explicit bean name) and `@org.springframework.context.annotation.Profile("mongodb")`.
        *   Injects and uses the `TagMongoRepository`. The `@Cacheable(value = CacheName.ALL_TAGS)` annotation is retained on the `findAll()` method for consistency.
    *   Code:
        ```java
        package io.zhc1.realworld.persistence;
        
        import java.util.List;
        
        import org.springframework.cache.annotation.Cacheable;
        import org.springframework.context.annotation.Profile;
        import org.springframework.stereotype.Component;
        
        import lombok.RequiredArgsConstructor;
        
        import io.zhc1.realworld.config.CacheName;
        import io.zhc1.realworld.model.Tag;
        import io.zhc1.realworld.model.TagRepository;
        
        @Profile("mongodb")
        @Component("tagMongoRepositoryAdapter") // Explicit bean name to avoid conflicts
        @RequiredArgsConstructor
        class TagMongoRepositoryAdapter implements TagRepository {
        
            private final TagMongoRepository tagMongoRepository;
        
            @Override
            @Cacheable(value = CacheName.ALL_TAGS)
            public List<Tag> findAll() {
                return tagMongoRepository.findAll();
            }
        }
        ```

**Success Criteria:**

- The `Tag.java` entity in `module/core` is correctly annotated with `@Document(collection = "tags")` alongside existing JPA annotations.
- The `TagMongoRepository.java` interface is created in `module/persistence`, extends `MongoRepository<Tag, String>`.
- The `TagJpaRepositoryAdapter.java` (formerly `TagRepositoryAdapter.java`) in `module/persistence` is correctly renamed (file and class), annotated with `@Profile("h2")`, and continues to implement `TagRepository` using `TagJpaRepository`.
- The new `TagMongoRepositoryAdapter.java` is created in `module/persistence`, implements `TagRepository`, is annotated with `@Component("tagMongoRepositoryAdapter")` and `@Profile("mongodb")`, and correctly uses `TagMongoRepository`.
- The changelog is updated with this entry.
- The full application test suite (`./gradlew clean test`) passes with the default "h2" profile active, ensuring that these changes (including the new, currently inactive MongoDB components and the modified Tag entity) have not introduced regressions to the existing H2 functionality.
---

## 2025-06-11 - Task 2.3: Refactor Article persistence (Partial)

**Related Task:** Phase 2, Task 2.3 (Refactor Article persistence)

**Reason for Change:**

To migrate the `Article` entity and its core persistence layer components to support MongoDB. This is a complex entity due to its multiple relationships (User, Tag, ArticleComment, ArticleFavorite) and reliance on `JpaSpecificationExecutor` for dynamic queries. This task focuses on annotating the `Article` entity, creating the basic MongoDB repository and adapter structures, and deferring the full implementation of complex query logic and related entity operations (like saving tags or handling favorites/comments) to subsequent tasks or when those entities are migrated.

**Summary of Changes:**

*   **Annotate `Article` entity for MongoDB:**
    *   File: `module/core/src/main/java/io/zhc1/realworld/model/Article.java`
    *   Change: Added `@org.springframework.data.mongodb.core.mapping.Document(collection = "articles")`. Added `@org.springframework.data.mongodb.core.mapping.DBRef` to the `author` (User) and `articleTags` (Set<ArticleTag>) fields to indicate these will be references to documents in other collections.
    *   Diff:
        ```diff
        --- a/module/core/src/main/java/io/zhc1/realworld/model/Article.java
        +++ b/module/core/src/main/java/io/zhc1/realworld/model/Article.java
        @@ -20,7 +20,11 @@
         import lombok.Getter;
         import lombok.NoArgsConstructor;
         
        +import org.springframework.data.mongodb.core.mapping.DBRef;
        +import org.springframework.data.mongodb.core.mapping.Document;
        +
         @Entity
        +@Document(collection = "articles") // Added for MongoDB
         @Getter
         @SuppressWarnings("JpaDataSourceORMInspection")
         @NoArgsConstructor(access = AccessLevel.PROTECTED)
        @@ -32,6 +36,7 @@
         
             @ManyToOne
             @JoinColumn(name = "author_id", nullable = false)
        +    @DBRef // Added for MongoDB
             private User author;
         
             @Column(length = 50, unique = true, nullable = false)
        @@ -47,6 +52,7 @@
             private String content;
         
             @OneToMany(mappedBy = "article", cascade = CascadeType.ALL, fetch = FetchType.EAGER)
        +    @DBRef // Added for MongoDB, implies ArticleTag will be a separate document collection
             private final Set<ArticleTag> articleTags = new HashSet<>();
         
             @Column(nullable = false, updatable = false)
        ```

*   **Create `ArticleMongoRepository` interface:**
    *   New File: `module/persistence/src/main/java/io/zhc1/realworld/persistence/ArticleMongoRepository.java`
    *   Content: Interface extending `org.springframework.data.mongodb.repository.MongoRepository<Article, Integer>`. Includes derived queries for `findBySlug`, `findByAuthorInOrderByCreatedAtDesc`, `existsByTitle`, `findByArticleTagsTagName`, `findByAuthorUsername`, and `findAllByOrderByCreatedAtDesc`. Notes that more complex queries (previously `JpaSpecificationExecutor`) will be handled in the adapter using `MongoTemplate`.
    *   Code:
        ```java
        package io.zhc1.realworld.persistence;
        // ... imports ...
        interface ArticleMongoRepository extends MongoRepository<Article, Integer> {
            Optional<Article> findBySlug(String slug);
            Page<Article> findByAuthorInOrderByCreatedAtDesc(Collection<User> authors, Pageable pageable);
            boolean existsByTitle(String title);
            Page<Article> findByArticleTagsTagName(String tagName, Pageable pageable);
            Page<Article> findByAuthorUsername(String username, Pageable pageable);
            Page<Article> findAllByOrderByCreatedAtDesc(Pageable pageable);
            // Note: More complex queries ... will be implemented in ... ArticleMongoRepositoryAdapter ...
        }
        ```

*   **Isolate existing JPA Adapter (`ArticleRepositoryAdapter`):**
    *   File Renamed: `module/persistence/src/main/java/io/zhc1/realworld/persistence/ArticleRepositoryAdapter.java` to `ArticleJpaRepositoryAdapter.java`.
    *   Class Name Change: Updated from `ArticleRepositoryAdapter` to `ArticleJpaRepositoryAdapter`.
    *   Annotation Added: `@org.springframework.context.annotation.Profile("h2")`.

*   **Create `ArticleMongoRepositoryAdapter` for MongoDB (Partial Implementation):**
    *   New File: `module/persistence/src/main/java/io/zhc1/realworld/persistence/ArticleMongoRepositoryAdapter.java`
    *   Content: Implements `ArticleRepository`. Annotated with `@Component("articleMongoRepositoryAdapter")` and `@Profile("mongodb")`.
        *   Injects `ArticleMongoRepository`, `TagMongoRepository`, `UserRepository`, and `MongoTemplate`.
        *   `save(Article article)`: Basic save operation.
        *   `save(Article article, Collection<Tag> tags)`: Saves the article and ensures tags exist. Linking `ArticleTag` documents is marked as `TODO` as it depends on `ArticleTagMongoRepository`.
        *   `findAll(ArticleFacets facets)`: Uses `MongoTemplate` and `Criteria` API for querying. Author facet is implemented. Tag and Favorited facets are marked as `TODO` as they depend on `ArticleTag` and `ArticleFavorite` persistence respectively.
        *   `findBySlug`, `findByAuthors`, `existsBy`: Delegate to `ArticleMongoRepository`.
        *   `findArticleDetails`: Placeholder implementation returning 0 for `totalFavorites` and `false` for `favorited`, with `TODO` comments for full implementation pending `ArticleFavoriteMongoRepository`. Corrected `long` to `int` type for `totalFavorites` parameter in `ArticleDetails` constructor calls.
        *   `delete(Article article)`: Deletes the article. Deletion of related `ArticleComment`, `ArticleFavorite`, and `ArticleTag` documents is marked as `TODO`.

**Note on Complexity and Approach:**
The `Article` entity is central and has multiple relationships. This initial refactoring for Task 2.3 focuses on setting up the `Article` entity itself for MongoDB and its direct repository/adapter. The full logic for handling its relationships (tags, comments, favorites) and complex dynamic queries (especially those involving these related entities) is deferred. This phased approach within the entity's migration allows for incremental progress and testing.

**Success Criteria:**

- The `Article.java` entity in `module/core` is correctly annotated with `@Document` and relevant fields with `@DBRef`.
- The `ArticleMongoRepository.java` interface is created in `module/persistence` with basic derived query methods.
- The `ArticleJpaRepositoryAdapter.java` in `module/persistence` is correctly renamed, profiled, and implements `ArticleRepository` using JPA.
- The new `ArticleMongoRepositoryAdapter.java` is created in `module/persistence`, implements `ArticleRepository`, is profiled for MongoDB, and contains the initial structure for MongoDB operations, including `MongoTemplate` usage for `findAll(ArticleFacets)` and `TODO` markers for deferred logic.
- The changelog is updated with this entry.
- The full application test suite (`./gradlew clean test`) passes with the default "h2" profile active, ensuring no regressions to existing functionality.
- Complex query translations using `MongoTemplate` for `findAll(ArticleFacets)` and operations involving not-yet-migrated related entities (ArticleTag, ArticleComment, ArticleFavorite) are explicitly marked as `TODO` and deferred.
---
